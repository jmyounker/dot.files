#!/usr/bin/env python


import contextlib
import os
import sys
import tempfile


def main():
    if len(sys.argv) != 2:
        print >> sys.stderr, "usage: foo | %s OUTFILE" % sys.argv[0]
        sys.exit(127)
    with open_replace(os.path.abspath(sys.argv[1])) as f:
        for line in sys.stdin:
            f.write(line)


@contextlib.contextmanager
def open_replace(filename):
    dirname, basename = os.path.split(filename)
    tf = tempfile.NamedTemporaryFile(dir=dirname, prefix=basename, delete=False)
    try:
        yield tf
    finally:
        tf.close()
    os.rename(filename, filename + '.back')
    os.rename(tf.name, filename)


if __name__ == '__main__':
    main()





